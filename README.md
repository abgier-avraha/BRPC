# üÖ±Ô∏èRPC

An experiment using Typescript's `import type` feature and ES proxies to achieve something like TRPC. Support Open API spec compatibility if you use the default JSON serializer.

## Example

### Server

```ts
import { z } from "zod";
import { IMiddleware, createApi } from "../../server/src/index";

export type ApiType = typeof api;

type ServerContext = {};

const EchoRequestSchema = z.object({
  phrase: z.string(),
  date: z.date(),
  nested: z.object({
    arrayOfNumbers: z.array(z.number()),
  }),
});

const EchoResponseSchema = z.object({
  phrase: z.string(),
  date: z.date(),
  nested: z.object({
    arrayOfNumbers: z.array(z.number()),
  }),
});

export const api = createApi(
  // Rpcs
  {
    echo: {
      handler: async (
        req: z.infer<typeof EchoRequestSchema>,
        _ctx: ServerContext
      ) => {
        return { phrase: req.phrase, date: req.date, nested: req.nested };
      },
      requestSchema: EchoRequestSchema,
      responseSchema: EchoResponseSchema,
    },
  },
  // Server context fetcher
  () => ({}),
  {
    // Optional policies
    base: [
      // Optional middleware
    ],
  },
);

await startServer(api, 3000, superjson);

// Optional OpenAPI spec generation via https://www.npmjs.com/package/zod-to-json-schema
// Does not work with superjson or dates
fs.writeFileSync(
  path.join(__dirname, "api.spec.yml"),
  generateOpenApiSpec(api)
);
```

### Client

```ts
import { createChannel } from "client/index";
// Important! Using `import type` prevents the server from from being bundled with the client
// `import type` declarations are erased during compilation and are only used for static analysis
import type { ApiType } from "../../server";

// Create a communication channel with optional middleware
const client = createChannel<ApiType>("http://localhost:3000", {
  middleware: [],
  serializer: superjson,
});
const res = await client.echo({ phrase: "Hello world!" });
```

You can also codegen a client for a non-TypeScript application from the open API specification generated by BRPC using OpenAPI generator https://openapi-generator.tech/

### React Integration

- Full SSR with client side hydration example can be found here `packages/brpc-nextjs-example`
  - Utilizes TanStack's `useSuspenseQuery`


```tsx
// Setup your frontend client provider
"use client";

import { createChannel } from "brpc-client/src";
import { BrpcProvider } from "brpc-react";
import { useMemo } from "react";
import type { ApiType } from "../../../run-brpc-server";
import superjson from "superjson";
import {
	DehydratedState,
	hydrate,
	QueryClient,
	QueryClientProvider,
} from "@tanstack/react-query";

const queryClient = new QueryClient();

export function Providers(props: {
	children: React.ReactNode;
	state: DehydratedState;
}) {
	const frontendClient = useMemo(() => {
		return createChannel<ApiType>("http://localhost:3001", {
			middleware: [],
			serializer: superjson,
		});
	}, []);

	hydrate(queryClient, props.state);

	return (
		<QueryClientProvider client={queryClient}>
			<BrpcProvider api={frontendClient}>{props.children}</BrpcProvider>
		</QueryClientProvider>
	);
}
```

```tsx
import { Suspense } from "react";
import { SuspendedComponent } from "./_components/suspended-component";
import { createApi } from "./api";
import { Providers } from "./_components/providers";
import { dehydrate } from "@tanstack/react-query";

export default async function Page() {
	const { queryClient, api } = createApi();
	await queryClient.prefetchQuery({
		queryKey: ["echo-random"],
		queryFn: () =>
			api.echo({
				phrase: "test",
				date: new Date("1995-12-17T03:24:00"),
				nested: {
					arrayOfNumbers: [1, 2, 3, 4],
				},
			}),
	});

	const dehydratedState = dehydrate(queryClient);

	return (
		<div className="font-sans grid grid-rows-[20px_1fr_20px] items-center justify-items-center min-h-screen p-8 pb-20 gap-16 sm:p-20">
			<Providers state={dehydratedState}>
				<Suspense fallback={<div>Loading...</div>}>
					<SuspendedComponent />
				</Suspense>
			</Providers>
		</div>
	);
}
```

```tsx
// Client components will fully render server side according to what is in the hydration snapshot
"use client";

import { useApi } from "../_hooks/use-api";
import { useSuspenseQuery } from "@tanstack/react-query";

export const SuspendedComponent = () => {
	const api = useApi();

	const { data } = useSuspenseQuery({
		queryKey: ["echo-random"],
		queryFn: () =>
			api.echo({
				phrase: "test",
				date: new Date("1995-12-17T03:24:00"),
				nested: {
					arrayOfNumbers: [1, 2, 3, 4],
				},
			}),
	});

	return (
		<div>
			<p>{data.phrase}</p>
			<p>{data.nested.arrayOfNumbers.join(" ")}</p>
			<p>{data.date.toISOString()}</p>
		</div>
	);
};

```

## Dev

### Run Tests

`pnpm install`

`pnpm test`
